AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: Shared infrastructure for both cloud security and log analysis
Metadata:
  AWS::ServerlessRepo::Application:
    Name: panther-core
    Description: Core Panther services for both cloud security and log analysis
    Author: Panther Labs
    HomePageUrl: https://runpanther.io
    SemanticVersion: 0.1.0
    SourceCodeUrl: https://github.com/panther-labs/panther
Parameters:
  AppDomainURL:
    Type: String
    Description: Panther App Domain used as a link for the customer in the password
      reset email
  AnalysisVersionsBucket:
    Type: String
    Description: S3 bucket for python revision history
  AnalysisApiId:
    Type: String
    Description: Analysis API gateway ID
  ComplianceApiId:
    Type: String
    Description: Compliance API gateway ID
  OutputsKeyId:
    Type: String
    Description: KMS key for encrypting alert outputs
  SqsKeyId:
    Type: String
    Description: KMS key for encrypting SQS queues
  UserPoolId:
    Type: String
    Description: Cognito user pool ID
  CloudWatchLogRetentionDays:
    Type: Number
    Description: CloudWatch log retention period
    Default: 365
  Debug:
    Type: String
    Default: false
    Description: Toggle debug logging
    AllowedValues:
      - true
      - false
  LayerVersionArns:
    Type: CommaDelimitedList
    Description: List of LayerVersion ARNs to attach to each function
    Default: ''
  TracingMode:
    Type: String
    Description: Enable XRay tracing on Lambda and API Gateway
    AllowedValues:
      - ''
      - Active
      - PassThrough
    Default: ''
  AlertRetryDurationMins:
    Type: Number
    Description: Alerts which fail to send will be retried for this duration
    Default: 30
    MinValue: 5
    MaxValue: 10080
  MinRetryDelaySecs:
    Type: Number
    Description: Wait at least this long before retrying a failed alert
    Default: 30
    MinValue: 1
    MaxValue: 86400
  MaxRetryDelaySecs:
    Type: Number
    Description: Wait at most this long before retrying a failed alert
    Default: 300
    MinValue: 1
    MaxValue: 86400
  AlertSqsRetentionSec:
    Type: Number
    Description: Number of seconds SQS will retain a message in the alerts queue
    Default: 259200
    MinValue: 60
    MaxValue: 1209600
Conditions:
  AttachLayers:
    Fn::Not:
      - Fn::Equals:
          - Fn::Join:
              - ''
              - Ref: LayerVersionArns
          - ''
  TracingEnabled:
    Fn::Not:
      - Fn::Equals:
          - ''
          - Ref: TracingMode
Resources:
  UsersAPILogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/panther-users-api
      RetentionInDays:
        Ref: CloudWatchLogRetentionDays
  UsersAPIFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://panther-austin-sam/3bd90fa6fb6e50a3d411c3d793ba950b
      Description: CRUD actions for the cognito api
      Environment:
        Variables:
          APP_DOMAIN_URL:
            Ref: AppDomainURL
          DEBUG:
            Ref: Debug
          USER_POOL_ID:
            Ref: UserPoolId
      FunctionName: panther-users-api
      Handler: main
      Layers:
        Fn::If:
          - AttachLayers
          - Ref: LayerVersionArns
          - Ref: AWS::NoValue
      MemorySize: 128
      Runtime: go1.x
      Timeout: 60
      Tracing:
        Fn::If:
          - TracingEnabled
          - Ref: TracingMode
          - Ref: AWS::NoValue
      Policies:
        - Id: CognitoUserManagement
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:AdminCreateUser
                - cognito-idp:AdminDeleteUser
                - cognito-idp:AdminDisableUser
                - cognito-idp:AdminEnableUser
                - cognito-idp:AdminGetUser
                - cognito-idp:AdminResetUserPassword
                - cognito-idp:AdminUpdateUserAttributes
                - cognito-idp:GetUser
                - cognito-idp:ListUsers
              Resource:
                Fn::Sub: arn:${AWS::Partition}:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${UserPoolId}
        - Id: AppsyncManagement
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - appsync:GetGraphqlApi
                - appsync:ListGraphqlApis
                - appsync:UpdateGraphqlApi
              Resource:
                Fn::Sub: arn:${AWS::Partition}:appsync:${AWS::Region}:${AWS::AccountId}:*
  CustomMessageTriggerInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::GetAtt:
          - UsersAPIFunction
          - Arn
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn:
        Fn::Sub: arn:${AWS::Partition}:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${UserPoolId}
  OrganizationTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      TableName: panther-organization
  OrganizationAPILogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/panther-organization-api
      RetentionInDays:
        Ref: CloudWatchLogRetentionDays
  OrganizationAPIFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://panther-austin-sam/c86406a777397cd51a26fe50150e6ab8
      Description: CRUD actions for the organization database
      Environment:
        Variables:
          DEBUG:
            Ref: Debug
          ORG_TABLE_NAME:
            Ref: OrganizationTable
      FunctionName: panther-organization-api
      Handler: main
      Layers:
        Fn::If:
          - AttachLayers
          - Ref: LayerVersionArns
          - Ref: AWS::NoValue
      MemorySize: 128
      Runtime: go1.x
      Timeout: 60
      Tracing:
        Fn::If:
          - TracingEnabled
          - Ref: TracingMode
          - Ref: AWS::NoValue
      Policies:
        - Id: ManageOrganizationTable
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:*Item
                - dynamodb:Scan
              Resource:
                Fn::GetAtt:
                  - OrganizationTable
                  - Arn
  AnalysisApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://panther-austin-sam/3f440dea70b13491820231699ff7c289
      Description: Analysis API
      Environment:
        Variables:
          BUCKET:
            Ref: AnalysisVersionsBucket
          COMPLIANCE_API_HOST:
            Fn::Sub: ${ComplianceApiId}.execute-api.${AWS::Region}.${AWS::URLSuffix}
          COMPLIANCE_API_PATH: v1
          DEBUG:
            Ref: Debug
          LAYER_MANAGER_QUEUE_URL:
            Fn::Sub: https://sqs.${AWS::Region}.${AWS::URLSuffix}/${AWS::AccountId}/panther-layer-manager-queue
          POLICY_ENGINE: panther-policy-engine
          RULES_ENGINE: panther-rules-engine
          RESOURCE_QUEUE_URL:
            Fn::Sub: https://sqs.${AWS::Region}.${AWS::URLSuffix}/${AWS::AccountId}/panther-resources-queue
          TABLE:
            Ref: AnalysisTable
      FunctionName: panther-analysis-api
      Handler: main
      MemorySize: 512
      Layers:
        Fn::If:
          - AttachLayers
          - Ref: LayerVersionArns
          - Ref: AWS::NoValue
      Runtime: go1.x
      Timeout: 120
      Tracing:
        Fn::If:
          - TracingEnabled
          - Ref: TracingMode
          - Ref: AWS::NoValue
      Policies:
        - Id: InvokeApis
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: execute-api:Invoke
              Resource:
                - Fn::Sub: arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${ComplianceApiId}/v1/GET/describe-org
                - Fn::Sub: arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${ComplianceApiId}/v1/POST/delete
                - Fn::Sub: arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${ComplianceApiId}/v1/POST/update
            - Effect: Allow
              Action: lambda:InvokeFunction
              Resource:
                - Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:panther-policy-engine
                - Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:panther-rules-engine
        - Id: ManageDataStores
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:*Item
                - dynamodb:Query
                - dynamodb:Scan
              Resource:
                Fn::GetAtt:
                  - AnalysisTable
                  - Arn
            - Effect: Allow
              Action:
                - s3:DeleteObject
                - s3:GetObject*
                - s3:PutObject
              Resource:
                Fn::Sub: arn:${AWS::Partition}:s3:::${AnalysisVersionsBucket}/*
            - Effect: Allow
              Action:
                - s3:ListBucket
                - s3:ListBucketVersions
              Resource:
                Fn::Sub: arn:${AWS::Partition}:s3:::${AnalysisVersionsBucket}
        - Id: PublishToResourceQueue
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
                - sqs:SendMessageBatch
              Resource:
                Fn::Sub: arn:${AWS::Partition}:sqs:${AWS::Region}:${AWS::AccountId}:panther-resources-queue
            - Effect: Allow
              Action:
                - kms:Decrypt
                - kms:GenerateDataKey
              Resource:
                Fn::Sub: arn:${AWS::Partition}:kms:${AWS::Region}:${AWS::AccountId}:key/${SqsKeyId}
        - Id: PublishToLayerManagerQueue
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: sqs:SendMessage
              Resource:
                Fn::Sub: arn:${AWS::Partition}:sqs:${AWS::Region}:${AWS::AccountId}:panther-layer-manager-queue
  AnalysisApiLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/panther-analysis-api
      RetentionInDays:
        Ref: CloudWatchLogRetentionDays
  GatewayInvocationPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: AnalysisApiFunction
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${AnalysisApiId}/*
  AnalysisTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      TableName: panther-analysis
  OutputsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: outputId
          AttributeType: S
        - AttributeName: displayName
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
        - IndexName: displayName-index
          KeySchema:
            - AttributeName: displayName
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      KeySchema:
        - AttributeName: outputId
          KeyType: HASH
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      TableName: panther-outputs
  OutputsApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://panther-austin-sam/bcdee02de267aaaeced0ed6eb684b9e2
      Description: CRUD actions for alert outputs
      Environment:
        Variables:
          DEBUG:
            Ref: Debug
          KEY_ID:
            Ref: OutputsKeyId
          OUTPUTS_TABLE_NAME:
            Ref: OutputsTable
          OUTPUTS_DISPLAY_NAME_INDEX_NAME: displayName-index
      FunctionName: panther-outputs-api
      Handler: main
      Layers:
        Fn::If:
          - AttachLayers
          - Ref: LayerVersionArns
          - Ref: AWS::NoValue
      MemorySize: 512
      Runtime: go1.x
      Timeout: 60
      Tracing:
        Fn::If:
          - TracingEnabled
          - Ref: TracingMode
          - Ref: AWS::NoValue
      Policies:
        - Id: OutputsTables
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:DeleteItem
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:Query
                - dynamodb:Scan
                - dynamodb:UpdateItem
              Resource:
                - Fn::GetAtt:
                    - OutputsTable
                    - Arn
                - Fn::Sub: ${OutputsTable.Arn}/index/*
        - Id: CredentialEncryption
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - kms:Decrypt
                - kms:Encrypt
                - kms:GenerateDataKey
              Resource:
                Fn::Sub: arn:${AWS::Partition}:kms:${AWS::Region}:${AWS::AccountId}:key/${OutputsKeyId}
  OutputsApiLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/panther-outputs-api
      RetentionInDays:
        Ref: CloudWatchLogRetentionDays
  AlertQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: panther-alerts-queue
      MessageRetentionPeriod:
        Ref: AlertSqsRetentionSec
      KmsMasterKeyId:
        Ref: SqsKeyId
      VisibilityTimeout: 60
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
            - AlertDLQ
            - Arn
        maxReceiveCount: 10
  AlertDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: panther-alerts-queue-dlq
      MessageRetentionPeriod: '1209600'
      VisibilityTimeout: 60
  AlertDeliveryFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://panther-austin-sam/dd1f5750a0109eecc79c1e6a0e6af7bf
      Description: Dispatch alerts to their specified outputs
      Environment:
        Variables:
          DEBUG:
            Ref: Debug
          ALERT_QUEUE_URL:
            Ref: AlertQueue
          ALERT_RETRY_DURATION_MINS:
            Ref: AlertRetryDurationMins
          ALERT_URL_PREFIX:
            Fn::Sub: https://${AppDomainURL}/log-analysis/alerts/
          MAX_RETRY_DELAY_SECS:
            Ref: MaxRetryDelaySecs
          MIN_RETRY_DELAY_SECS:
            Ref: MinRetryDelaySecs
          OUTPUTS_API: panther-outputs-api
          OUTPUTS_REFRESH_INTERVAL_MIN: '5'
          POLICY_URL_PREFIX:
            Fn::Sub: https://${AppDomainURL}/cloud-security/policies/
      Events:
        AlertQueue:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
                - AlertQueue
                - Arn
            BatchSize: 10
      Layers:
        Fn::If:
          - AttachLayers
          - Ref: LayerVersionArns
          - Ref: AWS::NoValue
      FunctionName: panther-alert-delivery
      Handler: main
      MemorySize: 128
      Runtime: go1.x
      Timeout: 60
      Tracing:
        Fn::If:
          - TracingEnabled
          - Ref: TracingMode
          - Ref: AWS::NoValue
      Policies:
        - Id: OutputsAPI
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: lambda:InvokeFunction
              Resource:
                Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:panther-outputs-api
        - Id: PublishSnsMessage
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: sns:Publish
              Resource: '*'
        - Id: SendSqsAlert
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: sqs:SendMessage
              Resource: '*'
        - Id: DecryptAlertMessages
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - kms:Decrypt
                - kms:GenerateDataKey
              Resource:
                Fn::Sub: arn:${AWS::Partition}:kms:${AWS::Region}:${AWS::AccountId}:key/${SqsKeyId}
        - Id: ReceiveAndDeleteAlerts
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - sqs:DeleteMessage
                - sqs:GetQueueAttributes
                - sqs:ReceiveMessage
              Resource:
                Fn::GetAtt:
                  - AlertQueue
                  - Arn
  AlertDeliveryLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/panther-alert-delivery
      RetentionInDays:
        Ref: CloudWatchLogRetentionDays
  IntegrationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: panther-source-integrations
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: integrationId
          AttributeType: S
      KeySchema:
        - AttributeName: integrationId
          KeyType: HASH
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
  SourceApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://panther-austin-sam/0e1dd6d91a3da5c6ea74512f1e7828f8
      Description: Manages database of source integrations
      Environment:
        Variables:
          DEBUG:
            Ref: Debug
          SNAPSHOT_POLLERS_QUEUE_URL:
            Fn::Sub: https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/panther-snapshot-queue
          LOG_PROCESSOR_QUEUE_URL:
            Fn::Sub: https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/panther-input-data-notifications-queue
          LOG_PROCESSOR_QUEUE_ARN:
            Fn::Sub: arn:${AWS::Partition}:sqs:${AWS::Region}:${AWS::AccountId}:panther-input-data-notifications-queue
          TABLE_NAME:
            Ref: IntegrationsTable
      FunctionName: panther-source-api
      Handler: main
      Layers:
        Fn::If:
          - AttachLayers
          - Ref: LayerVersionArns
          - Ref: AWS::NoValue
      MemorySize: 128
      Runtime: go1.x
      Timeout: 60
      Tracing:
        Fn::If:
          - TracingEnabled
          - Ref: TracingMode
          - Ref: AWS::NoValue
      Policies:
        - Id: IntegrationsTablePermissions
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:*Item
                - dynamodb:Query
                - dynamodb:Scan
              Resource:
                Fn::GetAtt:
                  - IntegrationsTable
                  - Arn
        - Id: SendSQSMessages
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
                - sqs:SendMessageBatch
              Resource:
                Fn::Sub: arn:${AWS::Partition}:sqs:${AWS::Region}:${AWS::AccountId}:panther-snapshot-queue
            - Effect: Allow
              Action:
                - kms:Decrypt
                - kms:GenerateDataKey
              Resource:
                Fn::Sub: arn:${AWS::Partition}:kms:${AWS::Region}:${AWS::AccountId}:key/${SqsKeyId}
        - Id: UpdateLogProcessorQueue
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: sqs:*QueueAttributes
              Resource:
                Fn::Sub: arn:${AWS::Partition}:sqs:${AWS::Region}:${AWS::AccountId}:panther-input-data-notifications-queue
        - Id: AssumePantherAuditRoles
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: sts:AssumeRole
              Resource:
                - Fn::Sub: arn:${AWS::Partition}:iam::*:role/PantherAuditRole-${AWS::Region}
                - Fn::Sub: arn:${AWS::Partition}:iam::*:role/PantherRemediationRole-${AWS::Region}
                - Fn::Sub: arn:${AWS::Partition}:iam::*:role/PantherCloudFormationStackSetExecutionRole-${AWS::Region}
                - Fn::Sub: arn:${AWS::Partition}:iam::*:role/PantherLogProcessingRole-*
        - Id: GetPublicTemplates
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: s3:GetObject
              Resource: arn:aws:s3:::panther-public-cloudformation-templates/*
  SourceApiLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/panther-source-api
      RetentionInDays:
        Ref: CloudWatchLogRetentionDays
  LayerQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: panther-layer-manager-queue
      MessageRetentionPeriod: '86400'
      KmsMasterKeyId:
        Ref: SqsKeyId
      VisibilityTimeout: 60
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
            - LayerDLQ
            - Arn
        maxReceiveCount: 10
  LayerDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: panther-layer-manager-queue-dlq
      MessageRetentionPeriod: '1209600'
      VisibilityTimeout: 60
  LayerManagerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://panther-austin-sam/386ab3372a8dd25d1c3a5515767b8a6c
      Description: Manage updates to the layers on the panther python engines.
      Environment:
        Variables:
          DEBUG:
            Ref: Debug
          GLOBAL_LAYER_NAME: panther-engine-globals
          GLOBAL_LAYER_ARN:
            Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:layer:panther-engine-globals
          POLICY_ENGINE:
            Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:panther-policy-engine
          RULE_ENGINE:
            Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:panther-rules-engine
          ANALYSIS_API_HOST:
            Fn::Sub: ${AnalysisApiId}.execute-api.${AWS::Region}.${AWS::URLSuffix}
          ANALYSIS_API_PATH: v1
      Events:
        LayerQueue:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
                - LayerQueue
                - Arn
            BatchSize: 10
      Layers:
        Fn::If:
          - AttachLayers
          - Ref: LayerVersionArns
          - Ref: AWS::NoValue
      FunctionName: panther-layer-manager
      Handler: main
      MemorySize: 512
      Runtime: go1.x
      Timeout: 60
      Tracing:
        Fn::If:
          - TracingEnabled
          - Ref: TracingMode
          - Ref: AWS::NoValue
      Policies:
        - Id: GetAnalyses
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: execute-api:Invoke
              Resource:
                - Fn::Sub: arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${AnalysisApiId}/v1/GET/global
        - Id: ManageEngines
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - lambda:GetFunctionConfiguration
                - lambda:UpdateFunctionConfiguration
              Resource:
                - Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:panther-policy-engine
                - Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:panther-rules-engine
        - Id: PublishLayer
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - lambda:PublishLayerVersion
                - lambda:ListLayerVersions
              Resource:
                Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:layer:panther-engine-globals
        - Id: DeleteLayerVersions
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: lambda:DeleteLayerVersion
              Resource:
                Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:layer:panther-engine-globals:*
        - Id: MaintainExistingLayers
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: lambda:GetLayerVersion
              Resource: '*'
        - Id: DecryptLayerMessages
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - kms:Decrypt
                - kms:GenerateDataKey
              Resource:
                Fn::Sub: arn:${AWS::Partition}:kms:${AWS::Region}:${AWS::AccountId}:key/${SqsKeyId}
        - Id: ReceiveAndDeleteMessages
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - sqs:DeleteMessage
                - sqs:GetQueueAttributes
                - sqs:ReceiveMessage
              Resource:
                Fn::GetAtt:
                  - LayerQueue
                  - Arn
  LayerManagerLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/panther-layer-manager
      RetentionInDays:
        Ref: CloudWatchLogRetentionDays
